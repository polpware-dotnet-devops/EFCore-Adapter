using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Casbin.Adapter.EFCore.Entities;
using Casbin.Adapter.EFCore.UnitTest.Fixtures;
using Microsoft.Data.Sqlite;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using NetCasbin;
using NetCasbin.Persist;
using Xunit;

namespace Casbin.Adapter.EFCore.UnitTest
{
    public class FiilterExploitTest : TestUtil, IClassFixture<ModelProvideFixture>, IDisposable
    {
        private readonly ModelProvideFixture _modelProvideFixture;
        private readonly CasbinDbContext<Guid> _context;

        public FiilterExploitTest(ModelProvideFixture modelProvideFixture)
        {
            _modelProvideFixture = modelProvideFixture;

            var config = new ConfigurationBuilder()
                .AddJsonFile("appsettings.test.json")
                .Build();

            var options = new DbContextOptionsBuilder<CasbinDbContext<Guid>>()
                .UseSqlServer(config.GetConnectionString("Default"))
                .Options;

            _context = new CasbinDbContext<Guid>(options);
            _context.Database.EnsureCreated();

            InitPolicy(_context);
        }

        public void Dispose()
        {
            Dispose(_context);
        }

        private void Dispose(CasbinDbContext<Guid> context)
        {
            context.RemoveRange(context.CasbinRule);
            context.SaveChanges();
        }

        private static void InitPolicy(CasbinDbContext<Guid> context)
        {
            context.CasbinRule.Add(new CasbinRule<Guid>
            {
                PType = "p",
                V0 = "alice",
                V1 = "data1",
                V2 = "read",
                V3 = "formlang1"
            });
            context.CasbinRule.Add(new CasbinRule<Guid>
            {
                PType = "p",
                V0 = "bob",
                V1 = "data1",
                V2 = "write",
                V3 = "formlang2"
            });
            context.CasbinRule.Add(new CasbinRule<Guid>
            {
                PType = "p",
                V0 = "data2_admin",
                V1 = "data2",
                V2 = "read",
            });
            context.CasbinRule.Add(new CasbinRule<Guid>
            {
                PType = "p",
                V0 = "data2_admin",
                V1 = "data2",
                V2 = "write",
            });
            context.CasbinRule.Add(new CasbinRule<Guid>
            {
                PType = "g",
                V0 = "alice",
                V1 = "data2_admin",
            });
            context.SaveChanges();
        }

        [Fact]
        public void TestExtraFilter()
        {
            var adapter = new EFCoreAdapter<Guid>(_context);
            var enforcer = new Enforcer(_modelProvideFixture.GetNewRbacModel(), adapter);

            enforcer.LoadFilteredPolicy(new Filter
            {
                P = new List<string> { "", "", "", "formlang1" },
            });
            TestGetPolicy(enforcer, AsList(
                AsList("alice", "data1", "read", "formlang1")
            ));
            var left = _context.CasbinRule.AsNoTracking().Count();
            Assert.True(5 == left);

        }
    }
}
